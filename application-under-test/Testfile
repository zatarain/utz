SOURCES := `find src/ -type f -name "*.cpp"`
TESTCASES:= `find utz/ -type f -name "*.tpp"`
MULTILINE:= sed -r 's/ /\n/g' | sed -r 's/^/\t/'
CXXFLAGS:= -std=c++17 -Wall -Wno-comment -fPIC -O2 -pipe

.SILENT: all application-under-test test

all: test

application-under-test:
	echo "Compiling application-under-test..."
	echo "Example source files:"
	echo ${SOURCES} | ${MULTILINE}
	mkdir -p bin/
	${CXX} ${CXXFLAGS} -shared -Isrc ${SOURCES} -o bin/libaut.so
	echo "Surccessfully compiled application under test library!"

test:
	echo "Compiling test cases..."
	echo "Test cases source files:"
	echo ${TESTCASES} | ${MULTILINE}
	mkdir -p bin/test/
	for testcase in ${TESTCASES}; do \
		file=`basename $$testcase`;\
		file="$${file%.*}";\
		echo "~~> $$testcase ($$file)";\
		${CXX} ${CXXFLAGS} -x c++ -Wl,--wrap=main -Isrc $$testcase\
			-o bin/test/$$file -Lbin -lutz -laut ;\
		LD_LIBRARY_PATH=$${LD_LIBRARY_PATH}:bin/ bin/test/$$file; \
	done